import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'package:flutter_tts/flutter_tts.dart';
import 'package:speech_to_text/speech_to_text.dart' as stt;

void main() {
  runApp(const NoheliaApp());
  }

  class NoheliaApp extends StatelessWidget {
    const NoheliaApp({super.key});

      @override
        Widget build(BuildContext context) {
            return const MaterialApp(
                  debugShowCheckedModeBanner: false,
                        home: NoheliaHome(),
                            );
                              }
                              }

                              class NoheliaHome extends StatefulWidget {
                                const NoheliaHome({super.key});

                                  @override
                                    State<NoheliaHome> createState() => _NoheliaHomeState();
                                    }

                                    class _NoheliaHomeState extends State<NoheliaHome>
                                        with SingleTickerProviderStateMixin {
                                          final TextEditingController _controller = TextEditingController();
                                            final FlutterTts flutterTts = FlutterTts();
                                              final stt.SpeechToText _speech = stt.SpeechToText();

                                                bool _isListening = false;
                                                  String _response = "Hola David, estoy lista.";
                                                    late AnimationController _animationController;

                                                      @override
                                                        void initState() {
                                                            super.initState();
                                                                _animationController =
                                                                        AnimationController(vsync: this, duration: const Duration(seconds: 2))
                                                                                  ..repeat(reverse: true);
                                                                                    }

                                                                                      Future<void> _listen() async {
                                                                                          if (!_isListening) {
                                                                                                bool available = await _speech.initialize();
                                                                                                      if (available) {
                                                                                                              setState(() => _isListening = true);
                                                                                                                      _speech.listen(onResult: (result) {
                                                                                                                                setState(() {
                                                                                                                                            _controller.text = result.recognizedWords;
                                                                                                                                                      });
                                                                                                                                                              });
                                                                                                                                                                    }
                                                                                                                                                                        } else {
                                                                                                                                                                              setState(() => _isListening = false);
                                                                                                                                                                                    _speech.stop();
                                                                                                                                                                                        }
                                                                                                                                                                                          }

                                                                                                                                                                                            Future<void> _sendMessage() async {
                                                                                                                                                                                                String message = _controller.text.trim();
                                                                                                                                                                                                    if (message.isEmpty) return;

                                                                                                                                                                                                        String lower = message.toLowerCase();

                                                                                                                                                                                                            try {
                                                                                                                                                                                                                  final res = await http.get(
                                                                                                                                                                                                                          Uri.parse("https://api.chucknorris.io/jokes/random"),
                                                                                                                                                                                                                                );

                                                                                                                                                                                                                                      if (res.statusCode == 200) {
                                                                                                                                                                                                                                              final data = jsonDecode(res.body);
                                                                                                                                                                                                                                                      _response = data["value"];
                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                    throw Exception();
                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                              } catch (_) {
                                                                                                                                                                                                                                                                                    // Respuestas inteligentes locales si falla la API
                                                                                                                                                                                                                                                                                          if (lower.contains("hola")) {
                                                                                                                                                                                                                                                                                                  _response = "Hola David. Me alegra escucharte.";
                                                                                                                                                                                                                                                                                                        } else if (lower.contains("como estas")) {
                                                                                                                                                                                                                                                                                                                _response = "Estoy funcionando perfectamente ahora que estoy contigo.";
                                                                                                                                                                                                                                                                                                                      } else if (lower.contains("quien eres")) {
                                                                                                                                                                                                                                                                                                                              _response = "Soy Nohelia, tu asistente inteligente en evolución.";
                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                            _response =
                                                                                                                                                                                                                                                                                                                                                        "Interesante lo que dices, David. Cuéntame más.";
                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                      setState(() {});
                                                                                                                                                                                                                                                                                                                                                                          await flutterTts.setLanguage("es-ES");
                                                                                                                                                                                                                                                                                                                                                                              await flutterTts.speak(_response);

                                                                                                                                                                                                                                                                                                                                                                                  _controller.clear();
                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                      @override
                                                                                                                                                                                                                                                                                                                                                                                        void dispose() {
                                                                                                                                                                                                                                                                                                                                                                                            _controller.dispose();
                                                                                                                                                                                                                                                                                                                                                                                                flutterTts.stop();
                                                                                                                                                                                                                                                                                                                                                                                                    _animationController.dispose();
                                                                                                                                                                                                                                                                                                                                                                                                        super.dispose();
                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                            @override
                                                                                                                                                                                                                                                                                                                                                                                                              Widget build(BuildContext context) {
                                                                                                                                                                                                                                                                                                                                                                                                                  return Scaffold(
                                                                                                                                                                                                                                                                                                                                                                                                                        body: Container(
                                                                                                                                                                                                                                                                                                                                                                                                                                decoration: const BoxDecoration(
                                                                                                                                                                                                                                                                                                                                                                                                                                          gradient: LinearGradient(
                                                                                                                                                                                                                                                                                                                                                                                                                                                      colors: [Colors.black, Color(0xFF1a0033)],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  begin: Alignment.topCenter,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              end: Alignment.bottomCenter,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        child: Padding(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  padding: const EdgeInsets.all(20),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            child: Column(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        children: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const SizedBox(height: 50),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    FadeTransition(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    opacity: _animationController,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    child: const Text(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "NOHELIA AI",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        style: TextStyle(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fontSize: 28,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                color: Colors.deepPurpleAccent,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fontWeight: FontWeight.bold,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        letterSpacing: 3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const SizedBox(height: 40),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Expanded(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    child: Center(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      child: Text(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          _response,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              style: const TextStyle(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    color: Colors.white,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          fontSize: 20,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  textAlign: TextAlign.center,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Row(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                children: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Expanded(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      child: TextField(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            controller: _controller,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  style: const TextStyle(color: Colors.white),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        decoration: const InputDecoration(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hintText: "Háblame o escribe...",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        hintStyle: TextStyle(color: Colors.grey),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                enabledBorder: OutlineInputBorder(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          borderSide:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        BorderSide(color: Colors.deepPurpleAccent),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        focusedBorder: OutlineInputBorder(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  borderSide:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                BorderSide(color: Colors.deepPurpleAccent),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      IconButton(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          icon: Icon(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                _isListening ? Icons.mic : Icons.mic_none,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      color: _isListening
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ? Colors.redAccent
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          : Colors.deepPurpleAccent,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  onPressed: _listen,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      IconButton(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          icon: const Icon(Icons.send,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  color: Colors.deepPurpleAccent),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      onPressed: _sendMessage,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }